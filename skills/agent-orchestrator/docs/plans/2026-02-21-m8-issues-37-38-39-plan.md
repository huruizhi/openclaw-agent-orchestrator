# Milestone 8 Issues 37/38/39 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Close milestone #8 issues #37/#38/#39 by converging docs/runtime defaults/events against current implementation.

**Architecture:** Keep existing modifications as base, add only acceptance-gap patches. Centralize runtime defaults in one module, wire worker/state_store to it, and enforce docs/runtime consistency through an executable check. Normalize operations docs to actual emitted events.

**Tech Stack:** Python 3, pytest, markdown docs, shell validation (`rg`, `jq`).

---

### Task 1: Issue #37 doc alignment (control plane behavior)

**Files:**
- Modify: `README.md`
- Modify: `FAQ.md`
- Modify: `Runbook.md`
- Modify: `QUICKSTART.md` (if any stale control examples found)

**Step 1: Write the failing test/check**

Run:
```bash
rg -n -e "python3 scripts/control.py .*--token" README.md FAQ.md QUICKSTART.md Runbook.md
```
Expected: at least one stale runnable `--token` usage before cleanup.

**Step 2: Implement minimal doc fix**
- Remove runnable `--token` examples.
- Add explicit v1.1.x note: local CLI trust boundary, no `--token` option.

**Step 3: Re-run verification**

Run:
```bash
rg -n -e "python3 scripts/control.py .*--token" README.md FAQ.md QUICKSTART.md Runbook.md
rg -n -e "不支持.*--token|local CLI|trust boundary|v1.2" README.md FAQ.md Runbook.md
```
Expected: no stale runnable `--token` examples; explicit behavior note exists.

**Step 4: Commit**
```bash
git add README.md FAQ.md QUICKSTART.md Runbook.md
git commit -m "docs: align control-plane docs with actual v1.1.x behavior (#37)"
```

### Task 2: Issue #38 runtime default source and integration

**Files:**
- Create: `scripts/runtime_defaults.py`
- Modify: `scripts/worker.py`
- Modify: `scripts/state_store.py`
- Modify: `.env.example`
- Modify: `CONFIG.md`

**Step 1: Write failing test/check**

Run:
```bash
python3 scripts/check_runtime_defaults.py
```
Expected: fails before script/inputs are complete.

**Step 2: Minimal implementation**
- Add default matrix and env readers in `scripts/runtime_defaults.py`.
- Wire `worker.py` defaults from matrix readers.
- Wire `state_store.py` stale/heartbeat log default behavior from matrix readers.
- Keep legacy alias compatibility for worker concurrency.

**Step 3: Update docs/env matrix**
- Sync `.env.example` and `CONFIG.md` to runtime defaults.

**Step 4: Verify**

Run:
```bash
python3 scripts/check_runtime_defaults.py
```
Expected: `[OK]`.

**Step 5: Commit**
```bash
git add scripts/runtime_defaults.py scripts/worker.py scripts/state_store.py .env.example CONFIG.md scripts/check_runtime_defaults.py
git commit -m "feat: unify runtime defaults and add drift check (#38)"
```

### Task 3: Issue #38 automated regression check + release matrix

**Files:**
- Create: `scripts/check_runtime_defaults.py`
- Create: `test_runtime_defaults_sync.py`
- Create: `docs/releases/v1.1.1.md`

**Step 1: Write failing test**

Create `test_runtime_defaults_sync.py` that shells out to `scripts/check_runtime_defaults.py` and expects exit code 0.

Run:
```bash
python3 -m pytest -q test_runtime_defaults_sync.py
```
Expected: fail until checker and release matrix exist.

**Step 2: Implement minimal code/docs**
- Implement checker script.
- Add release default matrix doc.

**Step 3: Verify**

Run:
```bash
python3 -m pytest -q test_runtime_defaults_sync.py
```
Expected: pass.

**Step 4: Commit**
```bash
git add scripts/check_runtime_defaults.py test_runtime_defaults_sync.py docs/releases/v1.1.1.md
git commit -m "test/docs: guard runtime-doc default drift and add release matrix (#38)"
```

### Task 4: Issue #39 event glossary and troubleshooting normalization

**Files:**
- Modify: `OPERATIONS.md`
- Modify: `README.md` (small links/text consistency only if needed)

**Step 1: Write failing check**

Run:
```bash
rg -n -e "running_stale_recovered" -e "runner_started|runner_finished|runner_invalid_output" OPERATIONS.md
```
Expected: stale/non-source-of-truth event names exist before cleanup.

**Step 2: Implement minimal doc changes**
- Add glossary from actual emitters in `scripts/control.py`, `scripts/worker.py`, `scripts/state_store.py`.
- Replace troubleshooting keywords with real event names.
- Add one end-to-end sample timeline.

**Step 3: Verify**

Run:
```bash
rg -n -e "stale_recovered|status_changed|job_timeout|job_failed|job_resumed|answer_consumed" OPERATIONS.md
```
Expected: glossary includes runtime events used in code.

**Step 4: Commit**
```bash
git add OPERATIONS.md README.md
git commit -m "docs: normalize event glossary and troubleshooting keywords (#39)"
```

### Task 5: Final integrated verification (verification-before-completion)

**Files:**
- Modify: `scripts/test_orchestrator_v2_sqlite.py` (if signature drift requires compatibility)

**Step 1: Run integrated tests**

Run:
```bash
python3 scripts/check_runtime_defaults.py
python3 -m pytest -q test_runtime_defaults_sync.py scripts/test_orchestrator_v2_sqlite.py scripts/test_worker_regression.py
```
Expected: all pass.

**Step 2: If failure, fix minimally and re-run**
- Keep fixes scoped to compatibility/regression only.

**Step 3: Final commit**
```bash
git add scripts/test_orchestrator_v2_sqlite.py
# include any remaining touched files from previous tasks
git commit -m "test: keep sqlite worker regression suite green after milestone-8 convergence"
```
