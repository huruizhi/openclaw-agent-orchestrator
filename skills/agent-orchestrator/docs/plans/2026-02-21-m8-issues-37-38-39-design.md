# Milestone 8 Issues 37/38/39 Design

## Scope
This design converges existing workspace changes to satisfy milestone #8 issues:
- #37 docs align with actual control-plane behavior
- #38 runtime defaults consistency + drift check
- #39 event glossary + troubleshooting keywords consistency

## In Scope
- Documentation alignment for control commands and trust boundary
- Runtime default single source-of-truth for worker/state-store knobs
- Automated drift check between runtime defaults and docs matrix
- Event glossary sourced from actual emitted worker/control/state_store events
- One end-to-end sample timeline in operations docs

## Out of Scope
- Implementing remote auth/token control plane features
- Renaming runtime event schema in code
- Broad refactor outside issue acceptance criteria

## Approach
1. Keep current code/doc changes as baseline.
2. Map current state to AC for #37/#38/#39 and patch only gaps.
3. Preserve backward compatibility for legacy env var (`ORCH_AGENT_MAX_CONCURRENCY`).
4. Validate with executable evidence (drift check + pytest suite).

## Acceptance Mapping
### Issue #37
- Remove unsupported `control.py --token` usage from runnable docs.
- Replace with explicit statement: local CLI trust boundary in v1.1.x.

### Issue #38
- Introduce runtime default matrix source in code.
- Ensure worker/state_store runtime behavior reads same defaults and env keys.
- Add automated check script for docs/runtime drift.
- Include v1.1.1 release default matrix doc.

### Issue #39
- Build event glossary from actual event emitters:
  - state_store: `job_submitted`, `job_claimed`, `heartbeat`, `stale_recovered`
  - worker: `status_changed`, `job_timeout`, `job_failed`, etc.
  - control: `audit_approved`, `audit_revise_requested`, `job_resumed`, etc.
- Provide troubleshooting queries with real event names.
- Add one end-to-end sample timeline.

## Risks and Mitigations
- Risk: documentation still references stale event names.
  - Mitigation: grep checks against docs + runtime event sources.
- Risk: env var migration breaks existing deployments.
  - Mitigation: keep legacy alias for worker concurrency.
- Risk: hidden defaults drift after future edits.
  - Mitigation: enforce `scripts/check_runtime_defaults.py` in tests.

## Validation Evidence
- `python3 scripts/check_runtime_defaults.py`
- `python3 -m pytest -q test_runtime_defaults_sync.py scripts/test_orchestrator_v2_sqlite.py scripts/test_worker_regression.py`
